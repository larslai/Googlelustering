/**
 * @author      OA Wu <comdan66@gmail.com>
 * @copyright   Copyright (c) 2016 OA Wu Design
 */

function OAMarkerClustering(a){"undefined"==typeof a&&(a={}),this.extend=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},this.objToArray=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},this.UNIT_LAT_LNG=1,this.UNIT_ARRAY=2,this.options=this.extend({maps:null,type:"runAll",runAllFilter:!0,maxZoom:16},a),this.objs=[],this.zooms=[],this.unit=this.UNIT_LAT_LNG,this.markers=[],this.lastZoom=-1,this.clusteringMarkerCallback=function(){return null},this.markerCallback=function(){return null},this.setLatLngs=function(a){return this.objs=a,this.unit=this.UNIT_LAT_LNG,this.transform(),"runAll"==this.options.type&&this.runAll(),"moveRun"==this.options.type&&this.moveRun(),this},this.setArrays=function(a){return this.objs=a,this.unit=this.UNIT_ARRAY,this.transform(),"runAll"==this.options.type&&this.runAll(),"moveRun"==this.options.type&&this.moveRun(),this},this.freeTransform=function(a){return delete a._hasChoice,delete a._lat,delete a._lng,this},this.transform=function(){switch(this.unit){default:case this.UNIT_LAT_LNG:this.transformLatLng=function(a){return a._hasChoice=!1,a._lat=a.lat(),a._lng=a.lng(),a};break;case this.UNIT_ARRAY:this.transformLatLng=function(a){return a._hasChoice=!1,a._lat=a[0],a._lng=a[1],a}}return this},this.setClusteringMarker=function(a){return this.clusteringMarkerCallback=a,this},this.setMarker=function(a){return this.markerCallback=a,this},this.moveRun=function(){return this.options.maps?(this.options.maps.addListener("idle",function(){var a=this.options.maps.getBounds(),b=a.getNorthEast(),c=a.getSouthWest(),d=c.lat(),e=b.lat(),f=c.lng(),g=c.lng()>0&&b.lng()<0?180+Math.abs(b.lng()):b.lng(),h=this.options.maps.zoom,i={},j=this.objs.map(this.transformLatLng).filter(function(a){return a._lat>=d&&a._lat<=e&&a._lng>=f&&a._lng<=g}.bind(this));if(h>=this.options.maxZoom)return this.markers.forEach(function(a){a.setMap(null)}),void(this.markers=this.objs.map(function(a){return this.markerCallback(a)}.bind(this)).filter(function(a){return a}));for(var k=0,l=j.length;k<l;k++)if(!j[k]._hasChoice){i[k]={point:j[k],count:1},j[k]._hasChoice=!0;for(var m=0;m<l;m++)if(!j[m]._hasChoice){var n=Math.max(Math.abs(j[k]._lat-j[m]._lat),Math.abs(j[k]._lng-j[m]._lng));30/Math.pow(2,h)>n&&(i[k].count+=1,j[m]._hasChoice=!0)}}j.forEach(this.freeTransform),this.markers.forEach(function(a){a.setMap(null)}),this.markers=this.objToArray(i).map(function(a){return 1==a.count?this.markerCallback(a.point):this.clusteringMarkerCallback(a.point,a.count)}.bind(this)).filter(function(a){return a instanceof google.maps.Marker})}.bind(this)),this):console.error("OAMarkerClustering - 尚未設置 maps！")},this.runAll=function(){if(!this.options.maps)return console.error("OAMarkerClustering - 尚未設置 maps！");this.objs.forEach(this.transformLatLng);for(var a=0,b=this.objs.length;a<this.options.maxZoom;a++){this.zooms[a]={};for(var c=0;c<b;c++)if(!this.objs[c]._hasChoice){this.zooms[a][c]={point:this.objs[c],count:1},this.objs[c]._hasChoice=!0;for(var d=0;d<b;d++)if(!this.objs[d]._hasChoice){var e=Math.max(Math.abs(this.objs[c]._lat-this.objs[d]._lat),Math.abs(this.objs[c]._lng-this.objs[d]._lng));30/Math.pow(2,a)>e&&(this.zooms[a][c].count+=1,this.objs[d]._hasChoice=!0)}}this.objs.forEach(function(a){a._hasChoice=!1})}return this.objs.forEach(this.freeTransform),this.zooms=this.zooms.map(this.objToArray),this.options.maps.addListener("idle",function(){var a=this.options.maps.zoom;this.lastZoom!=a&&(this.lastZoom=a,this.markers.forEach(function(a){a.setMap(null)}),this.markers="undefined"==typeof this.zooms[a]?this.objs.map(function(a){return this.markerCallback(a)}.bind(this)).filter(function(a){return a}):this.zooms[a].map(function(a){return 1==a.count?this.markerCallback(a.point):this.clusteringMarkerCallback(a.point,a.count)}.bind(this)).filter(function(a){return a instanceof google.maps.Marker}))}.bind(this)),this}}